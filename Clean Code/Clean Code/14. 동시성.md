# 동시성

동시성과 깔끔한 코드는 양립하기 아주 어렵다.

## 동시성이 필요한 이유 ?

동시성은 결합(coupling)을 없애는 전략이다. 즉, `무엇(What)`과 `언제(When)`을 분리하는 전략이다. 

무엇과 언제를 분리하면 애플리케이션 구조와 효율이 극적으로 나아진다.

- 동시성과 관련된 타장한 생각 몇 가지
  - 동시성은 다소 부하를 유발한다. 성능 측면에서 부하가 걸리며, 코드도 더 짜야 한다.
  - 동시성은 복잡하다.
  - 일반적으로 동시성 버그는 재현하기 어렵다.
  - 동시성을 구현하려면 흔히 근본적인 설계 전략을 재고해야 한다.

## 동시성 방어 원칙

동시성 코드가 일으키는 문제로부터 시스템을 방어하는 원칙과 기술

- Single Responsibility Principle, SRP : 단일 책임 원칙

SRP 는 주어진 메서드/클래스/컴포넌트를 변경할 이유가 하나여야 한다는 원칙이다.

__동시성 관련 코드는 다른 코드와 분리해야한다. 복잡도 하나만으로도 충분한 분리 대상이다.__

## 따름 정리(corollary) : 자료 범위를 제한하라

두 스레드가 객체 하나를 공유하고 필드를 수정하면 예상하지 못한 결과를 얻을 수 있다. 

이러한 문제 해결 방법으로 코드 내 `임계 영역(ciritical section)을 synchronized` 키워드로 보호하라고 권장한다.

하지만 synchronized 는 성능을 현저하게 떨어뜨리기 때문에 이러한 수를 줄이는 것이 중요하다.

__자료를 캡슐화(encapsulation)하고 공유 자료를 최대한 줄여야 한다.__

## 따름 정리 : 자료 사본을 사용하라

공유 자료를 줄이려면 공유 하지 않는 것이 가장 좋고, 그렇지 못하면 사본을 만들어 사용하는 것이 좋다.

사본으로 동기화를 피할 수 있다면 내부 잠금을 없애 절약한 수행 시간이 사본 생성과 가비지 컬렉션에 드는 부하를 상쇄할 가능성이 크다.

## 따름 정리 : 스레드는 가능한 독립적으로 구현하라

각 스레드는 클라이언트 요청 하나를 처리한다. 모든 정보는 비공유 출처에서 가져오며, 로컬 변수에 저장한다. 그러면 스레드는 동기화 걱정을 하지 않아도 된다.

HttpServlet 클래스에서 파생한 클래스는 모든 정보를 doGet 과 doPost 매개변수로 받는다. 따라서 각 서블릿이 자신이 독자적인 시스템인 양 요청을 처리한다.

__독자적인 스레드로, 가능하면 다른 프로세서에서, 돌려도 괜찮도록 자료를 독립적인 단위로 분할하라__

## 라이브러리를 이해하라

- 스레드 환경에 안전한 컬렉션을 사용한다. (자바 5부터 제공)
- 서로 무관한 작업을 수행할 때는 executor 프레임워크를 사용한다.
- 가능하면 스레드가 차단(blocking) 되지 않는 방법을 사용한다.
- 일부 클래스 라이브러리는 스레드에 안전하지 못하다.

ConcurrentHashMap 은 다중 스레드 환경에서 안전하며 거의 모든 상황에서 HashMap 보다 빠르다.

__자바에서는 java.util.concurrent, java.util.concurrent.atomic, java.util.concurrent.locks 를 익혀라__
